"""Visualization script for analyzing simulation results.

This script loads the CSV files generated by the simulation and creates
visualizations to analyze market dynamics, agent beliefs, and convergence.

Run with:
    python examples/visualize_results.py [run_id]

Example:
    python examples/visualize_results.py orderbook_demo_run1
"""

import sys
from pathlib import Path

try:
    import pandas as pd
    import matplotlib
    matplotlib.use('Agg')  # Use non-interactive backend
    import matplotlib.pyplot as plt
    import seaborn as sns
    PLOTTING_AVAILABLE = True
except ImportError:
    print("Warning: matplotlib, seaborn, or pandas not installed.")
    print("Install with: pip install pandas matplotlib seaborn")
    PLOTTING_AVAILABLE = False


def load_simulation_data(run_id: str, log_dir: Path = Path("simulation_logs")) -> dict:
    """Load all simulation data for a given run.
    
    Args:
        run_id: Run identifier (e.g., 'orderbook_demo_run1')
        log_dir: Directory containing log files
        
    Returns:
        Dictionary with loaded DataFrames
    """
    data = {}
    
    # Load market data
    market_csv = log_dir / f"{run_id}_market.csv"
    if market_csv.exists():
        data['market'] = pd.read_csv(market_csv)
        print(f"‚úì Loaded market data: {len(data['market'])} timesteps")
    
    # Load beliefs
    beliefs_csv = log_dir / f"{run_id}_beliefs.csv"
    if beliefs_csv.exists():
        data['beliefs'] = pd.read_csv(beliefs_csv)
        print(f"‚úì Loaded beliefs data: {len(data['beliefs'])} records")
    
    # Load sources
    sources_csv = log_dir / f"{run_id}_sources.csv"
    if sources_csv.exists():
        data['sources'] = pd.read_csv(sources_csv)
        print(f"‚úì Loaded sources data: {len(data['sources'])} messages")
    
    # Load agent metadata if exists
    agent_csv = log_dir / f"{run_id}_agent_meta.csv"
    if agent_csv.exists():
        data['agent_meta'] = pd.read_csv(agent_csv)
        print(f"‚úì Loaded agent metadata: {len(data['agent_meta'])} records")
    
    return data


def plot_price_evolution(market_df: pd.DataFrame, save_path: Path = None):
    """Plot market price evolution over time."""
    fig, ax = plt.subplots(figsize=(12, 6))
    
    ax.plot(market_df['timestep'], market_df['price'], 
            linewidth=2, label='Market Price', color='#2E86AB')
    
    # Add spread shading if available
    if 'best_bid' in market_df and 'best_ask' in market_df:
        mask = market_df['best_bid'].notna() & market_df['best_ask'].notna()
        if mask.any():
            ax.fill_between(
                market_df.loc[mask, 'timestep'],
                market_df.loc[mask, 'best_bid'],
                market_df.loc[mask, 'best_ask'],
                alpha=0.3,
                label='Bid-Ask Spread',
                color='#A23B72'
            )
    
    ax.set_xlabel('Timestep', fontsize=12)
    ax.set_ylabel('Price', fontsize=12)
    ax.set_title('Market Price Evolution', fontsize=14, fontweight='bold')
    ax.legend()
    ax.grid(True, alpha=0.3)
    
    plt.tight_layout()
    
    if save_path:
        plt.savefig(save_path, dpi=300, bbox_inches='tight')
        print(f"‚úì Saved plot: {save_path}")
    
    plt.close()


def plot_agent_beliefs(beliefs_df: pd.DataFrame, market_df: pd.DataFrame, save_path: Path = None):
    """Plot agent beliefs vs market price over time."""
    fig, ax = plt.subplots(figsize=(12, 6))
    
    # Plot market price
    ax.plot(market_df['timestep'], market_df['price'], 
            linewidth=2.5, label='Market Price', color='black', linestyle='--', zorder=10)
    
    # Plot each agent's beliefs
    agents = beliefs_df['agent_id'].unique()
    colors = sns.color_palette('husl', n_colors=len(agents))
    
    for i, agent_id in enumerate(agents):
        agent_data = beliefs_df[beliefs_df['agent_id'] == agent_id]
        ax.plot(agent_data['timestep'], agent_data['belief'], 
                linewidth=1.5, label=agent_id, color=colors[i], alpha=0.8)
    
    ax.set_xlabel('Timestep', fontsize=12)
    ax.set_ylabel('Belief / Price', fontsize=12)
    ax.set_title('Agent Beliefs vs Market Price', fontsize=14, fontweight='bold')
    ax.legend(bbox_to_anchor=(1.05, 1), loc='upper left')
    ax.grid(True, alpha=0.3)
    
    plt.tight_layout()
    
    if save_path:
        plt.savefig(save_path, dpi=300, bbox_inches='tight')
        print(f"‚úì Saved plot: {save_path}")
    
    plt.close()


def plot_volume_and_flow(market_df: pd.DataFrame, save_path: Path = None):
    """Plot trading volume and net flow over time."""
    fig, (ax1, ax2) = plt.subplots(2, 1, figsize=(12, 8), sharex=True)
    
    # Volume plot
    if 'volume' in market_df:
        ax1.bar(market_df['timestep'], market_df['volume'], 
                color='#06A77D', alpha=0.7, label='Tick Volume')
    
    ax1.set_ylabel('Volume', fontsize=12)
    ax1.set_title('Trading Volume per Tick', fontsize=12, fontweight='bold')
    ax1.legend()
    ax1.grid(True, alpha=0.3)
    
    # Net flow plot
    if 'net_flow' in market_df:
        colors = ['#D62828' if x < 0 else '#06A77D' for x in market_df['net_flow']]
        ax2.bar(market_df['timestep'], market_df['net_flow'], 
                color=colors, alpha=0.7)
        ax2.axhline(y=0, color='black', linestyle='-', linewidth=0.8)
    
    ax2.set_xlabel('Timestep', fontsize=12)
    ax2.set_ylabel('Net Flow', fontsize=12)
    ax2.set_title('Net Order Flow (Positive = Buy Pressure, Negative = Sell Pressure)', 
                  fontsize=12, fontweight='bold')
    ax2.grid(True, alpha=0.3)
    
    plt.tight_layout()
    
    if save_path:
        plt.savefig(save_path, dpi=300, bbox_inches='tight')
        print(f"‚úì Saved plot: {save_path}")
    
    plt.close()


def plot_belief_convergence(beliefs_df: pd.DataFrame, market_df: pd.DataFrame, save_path: Path = None):
    """Plot belief-price gap over time to show convergence."""
    fig, ax = plt.subplots(figsize=(12, 6))
    
    # Calculate mean belief per timestep
    mean_beliefs = beliefs_df.groupby('timestep')['belief'].mean().reset_index()
    mean_gaps = beliefs_df.groupby('timestep')['belief_price_gap'].mean().reset_index()
    
    # Plot mean gap
    ax.plot(mean_gaps['timestep'], mean_gaps['belief_price_gap'], 
            linewidth=2, label='Mean Belief-Price Gap', color='#F18F01')
    ax.axhline(y=0, color='black', linestyle='--', linewidth=0.8)
    
    ax.set_xlabel('Timestep', fontsize=12)
    ax.set_ylabel('Mean Absolute Gap', fontsize=12)
    ax.set_title('Convergence: Mean Belief-Price Gap Over Time', fontsize=14, fontweight='bold')
    ax.legend()
    ax.grid(True, alpha=0.3)
    
    plt.tight_layout()
    
    if save_path:
        plt.savefig(save_path, dpi=300, bbox_inches='tight')
        print(f"‚úì Saved plot: {save_path}")
    
    plt.close()


def plot_source_sentiment(sources_df: pd.DataFrame, save_path: Path = None):
    """Plot sentiment signals from different sources."""
    if 'sentiment' not in sources_df:
        print("‚ö† No sentiment data in sources")
        return
    
    fig, ax = plt.subplots(figsize=(12, 6))
    
    # Plot by source
    sources = sources_df['source_id'].unique()
    colors = sns.color_palette('Set2', n_colors=len(sources))
    
    for i, source in enumerate(sources):
        source_data = sources_df[sources_df['source_id'] == source]
        ax.scatter(source_data['timestep'], source_data['sentiment'], 
                  label=source, color=colors[i], alpha=0.6, s=50)
    
    ax.axhline(y=0, color='black', linestyle='--', linewidth=0.8)
    ax.set_xlabel('Timestep', fontsize=12)
    ax.set_ylabel('Sentiment', fontsize=12)
    ax.set_title('Information Signals by Source', fontsize=14, fontweight='bold')
    ax.legend()
    ax.grid(True, alpha=0.3)
    
    plt.tight_layout()
    
    if save_path:
        plt.savefig(save_path, dpi=300, bbox_inches='tight')
        print(f"‚úì Saved plot: {save_path}")
    
    plt.close()


def generate_summary_report(data: dict, run_id: str):
    """Generate a text summary report."""
    print("\n" + "=" * 80)
    print(f"SIMULATION SUMMARY: {run_id}")
    print("=" * 80)
    
    if 'market' in data:
        market = data['market']
        print(f"\nüìä Market Statistics:")
        print(f"   Timesteps: {len(market)}")
        print(f"   Initial Price: {market['price'].iloc[0]:.4f}")
        print(f"   Final Price: {market['price'].iloc[-1]:.4f}")
        print(f"   Price Change: {market['price'].iloc[-1] - market['price'].iloc[0]:+.4f}")
        print(f"   Mean Price: {market['price'].mean():.4f}")
        print(f"   Price Std Dev: {market['price'].std():.4f}")
        
        if 'total_volume' in market:
            print(f"   Total Volume: {market['total_volume'].iloc[-1]:.2f}")
        
        if 'spread' in market and market['spread'].notna().any():
            mean_spread = market['spread'].mean()
            print(f"   Mean Spread: {mean_spread:.4f}")
    
    if 'beliefs' in data:
        beliefs = data['beliefs']
        print(f"\nüß† Agent Beliefs:")
        agents = beliefs['agent_id'].unique()
        print(f"   Number of Agents: {len(agents)}")
        
        for agent in agents:
            agent_data = beliefs[beliefs['agent_id'] == agent]
            final_belief = agent_data['belief'].iloc[-1]
            mean_gap = agent_data['belief_price_gap'].mean()
            print(f"   {agent}:")
            print(f"      Final Belief: {final_belief:.4f}")
            print(f"      Mean Gap: {mean_gap:.4f}")
    
    if 'sources' in data:
        sources = data['sources']
        print(f"\nüì∞ Information Sources:")
        print(f"   Total Messages: {len(sources)}")
        
        if 'sentiment' in sources:
            print(f"   Mean Sentiment: {sources['sentiment'].mean():.4f}")
            print(f"   Sentiment Std Dev: {sources['sentiment'].std():.4f}")
        
        source_counts = sources['source_id'].value_counts()
        print(f"   Messages by Source:")
        for source, count in source_counts.items():
            print(f"      {source}: {count}")
    
    print("\n" + "=" * 80)


def main():
    """Main visualization function."""
    if not PLOTTING_AVAILABLE:
        print("\n‚ùå Cannot create visualizations without pandas, matplotlib, and seaborn")
        print("Install with: pip install pandas matplotlib seaborn")
        return
    
    # Get run_id from command line or use default
    if len(sys.argv) > 1:
        run_id = sys.argv[1]
    else:
        # List available runs
        log_dir = Path("simulation_logs")
        if log_dir.exists():
            market_files = list(log_dir.glob("*_market.csv"))
            if market_files:
                print("Available runs:")
                for i, f in enumerate(market_files, 1):
                    run_id = f.stem.replace("_market", "")
                    print(f"  {i}. {run_id}")
                
                if len(market_files) == 1:
                    run_id = market_files[0].stem.replace("_market", "")
                    print(f"\nUsing: {run_id}")
                else:
                    print("\nUsage: python examples/visualize_results.py [run_id]")
                    return
            else:
                print("No simulation logs found in 'simulation_logs/' directory")
                print("Run a simulation first with: python examples/demo_full_simulation.py")
                return
        else:
            print("No 'simulation_logs/' directory found")
            print("Run a simulation first with: python examples/demo_full_simulation.py")
            return
    
    print(f"\nLoading data for: {run_id}")
    print("-" * 80)
    
    # Load data
    data = load_simulation_data(run_id)
    
    if not data:
        print(f"‚ùå No data found for run: {run_id}")
        return
    
    # Generate summary
    generate_summary_report(data, run_id)
    
    # Create visualizations
    print("\nüìä Generating visualizations...")
    viz_dir = Path("visualizations")
    viz_dir.mkdir(exist_ok=True)
    
    if 'market' in data:
        plot_price_evolution(data['market'], 
                           save_path=viz_dir / f"{run_id}_price.png")
        
        plot_volume_and_flow(data['market'], 
                           save_path=viz_dir / f"{run_id}_volume.png")
    
    if 'beliefs' in data and 'market' in data:
        plot_agent_beliefs(data['beliefs'], data['market'], 
                         save_path=viz_dir / f"{run_id}_beliefs.png")
        
        plot_belief_convergence(data['beliefs'], data['market'], 
                              save_path=viz_dir / f"{run_id}_convergence.png")
    
    if 'sources' in data:
        plot_source_sentiment(data['sources'], 
                            save_path=viz_dir / f"{run_id}_sources.png")
    
    print(f"\n‚úÖ Visualizations saved to '{viz_dir}/' directory")


if __name__ == "__main__":
    main()

